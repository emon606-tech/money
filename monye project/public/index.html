const express = require('express');
const axios = require('axios');
const path = require('path');
const app = express();

const PORT = process.env.PORT || 8080;

// ✅ YOUR GITHUB DETAILS
const OWNER = "YOUR_GITHUB_USERNAME"; // ← change this!
const REPO = "WEBSERVER-MONEY";
const FILE_PATH = "CODE.txt";
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;

app.use(express.static('public'));

app.get('/random', async (req, res) => {
    const randomNumber = Math.floor(Math.random() * 90000) + 10000;
    const codeString = `private static string number = "${randomNumber}";`;

    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;

    try {
        // 🔍 Get current SHA of CODE.txt
        const { data } = await axios.get(url, {
            headers: {
                Authorization: `token ${GITHUB_TOKEN}`
            }
        });

        const sha = data.sha;

        // ✅ Update CODE.txt with new content
        await axios.put(url, {
            message: "Update random number",
            content: Buffer.from(codeString).toString('base64'),
            sha: sha
        }, {
            headers: {
                Authorization: `token ${GITHUB_TOKEN}`
            }
        });

        res.send(`Random Number: ${randomNumber}`);
    } catch (err) {
        console.error("GitHub Update Failed:", err.message);
        res.send("Something went wrong!");
    }
});

app.listen(PORT, () => {
    console.log(`✅ Server listening on port ${PORT}`);
});
